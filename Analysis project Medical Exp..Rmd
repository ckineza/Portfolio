
---
title: "Medical Expenditures Analysis"
output:
  pdf_document: default
  html_document: default
header-includes: \usepackage{multirow}
---

### Objective

The aim of this analysis is to estimate from the National Medical Expenditure Survey (NMES) data the fraction of total medical expenditures that are attributable to having a major smoking-caused disease (MSCD) --- including lung cancer, laryngeal cancer, COPD, CHD, stroke, and other cancers --- for different age, sex and demographic strata.

### Methods and Results

To estimate MSCD-attributable expenditures, we fit two models: (1) a logistic regression model for the probability of a positive expenditure and (2) a linear regression model for the size of the expenditure given a positive value.  For each model, we begin by exploring the association of the outcome with MSCD, age, sex and demographic variables to select the model form.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(grid)
library(dplyr)
library(boot)
library(gridExtra)
library(xtable)

load("~/Downloads/nmes.rdata")
#dat <- read.table('nmes.txt', header = TRUE)
dat <- nmes
dat$mscd <- (dat$lc5==1) | (dat$chd5==1)
dat$noexp <- (dat$totalexp == 0)
dat$RACE3 <- factor(dat$RACE3, levels=c(1,2,3), labels=c('white','black','other'))
dat$highincome <- ifelse(dat$povstalb=='.',NA,dat$povstalb==5)
dat$raceother <- (dat$RACE3=='other')

```

#### Model 1. Probability of positive expenditures

First we plot each variable of interest against the indicator of having zero expenditures.  Let $Y_i$ be the total expenditures for subject $i$.  Figure 1 shows that nearly all persons with an MSCD (male and female) have positive expenditures, regardless of age or gender.  Furthermore, we see that the probability of positive expenditures increases with age for those persons without an MSCD.  We also see that females tend to have a higher probability of positive expenditures than males, but this gap closes with increasing age.  Therefore, we include in our model interaction terms between age and MSCD, age and gender, and MSCD and gender. 

```{r, echo=FALSE, message=FALSE, cache=TRUE}
fig1<- ggplot(dat, aes(x=lastage, y=noexp, group=interaction(mscd, male), colour=mscd, linetype=factor(male))) + geom_jitter(size=0.5) + geom_smooth(size=1.1, alpha=0.5) + ylab('Zero Expenditures') + ggtitle('Figure 1') + xlab("Age") + scale_linetype_manual('Male', values=c(1,3)) + theme_bw() + theme(axis.text.y=element_text(angle=90, hjust=0.5), plot.margin=rep(unit(0,"null"),4), legend.position='bottom', legend.box='horizontal', text=element_text(size=9), legend.text=element_text(size=6)) + scale_x_continuous(breaks=seq(40,80,10))
#ggplot(dat, aes(x=LASTAGE, y=noexp, group=RACE3, colour=RACE3)) + geom_jitter(size=0.5, alpha=0.5) + geom_smooth(size=2) + ylab('Zero Expenditures') + theme_bw() + scale_colour_manual(values=c('blue','red','green')) + theme(legend.position='bottom', axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), axis.text.y=element_text(angle=90, hjust=0.5), plot.margin=rep(unit(0,"null"),4)) + ggtitle('Pr(Y=0) vs Age by Race') + xlab("Age")
#ggplot(dat, aes(x=LASTAGE, y=noexp, group=SREGION, colour=SREGION)) + geom_jitter(size=0.5, alpha=0.5) + geom_smooth(size=2) + ylab('Zero Expenditures') + theme_bw() + theme(legend.position='bottom', plot.margin=rep(unit(0,"null"),4), axis.text.y=element_text(angle=90, hjust=0.5)) + ggtitle('Pr(Y=0) vs Age by Region') + xlab("Age")
#ggplot(dat, aes(x=LASTAGE, y=noexp, group=POVSTALB, colour=POVSTALB)) + geom_jitter(size=0.5, alpha=0.5) + geom_smooth(size=2) + ylab('Zero Expenditures') + theme_bw() + theme(legend.position='bottom', axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), plot.margin=rep(unit(0,"null"),4), axis.text.y=element_text(angle=90, hjust=0.5)) + ggtitle('Pr(Y=0) vs Age by Income') + xlab("Age")
```

We perform similar exploratory analysis for the association with race, geographical region and poverty status.  We find that subjects with race = 'other' tend to have higher probability of positive expenditures across all ages.  We therefore include an indicator of race='other' in our model. Furthermore, subjects in the high income category appear to have a slightly higher probability of positive expenditures, possibly due to an increase in elective expenditures.  Therefore, we include an indicator of high income in our model. However, there does not appear to be a strong association between positive expenditures and geographical region.  There are missing values for income; however, there are only 56 missing values in a dataset of over 13,000 observations, which will be dropped from the analysis.

We now fit the following logistic regression model for zero expenditures, with age modeled as a cubic spline with a knot at 60:
\begin{align*}
\text{logit}Pr(Y_i=0) &= \beta_0 + \beta_1 MSCD_i + \beta_2 Sex_i + \beta_3 MSCD_i Sex_i + \beta_4 RaceOther_i + \beta_5 HighIncome_i \\ 
&+ \beta_6 Age_i + \beta_7 Age_i^3 + \beta_8 (Age_i-60)_+^3 + \\
&+ \beta_9 Age_i Sex_i + \beta_{10} Age_i^3 Sex_i + \beta_{11} (Age_i-60)_+^3 Sex_i \\
&+ \beta_{12} Age_i MSCD_i + \beta_{13} Age_i^3 MSCD_i + \beta_{14} (Age_i-60)_+^3 MSCD_i
\end{align*}


```{r, warning=FALSE, cache=TRUE, echo=FALSE, warning=FALSE}
dat$age_m40 <- (dat$lastage - 40)
dat$age_m40c <- (dat$age_m40)^3
dat$age_csp <- (ifelse(dat$lastage>60, dat$lastage-60, 0))^3
fit1a <- glm(noexp ~ (mscd + male)*(age_m40 + age_m40c + age_csp) + mscd*male + raceother + highincome, data=dat, family='binomial')
fit1b <- glm(noexp ~ (mscd + male)*age_m40 + mscd*male + raceother + highincome, data=dat, family='binomial')
fit1c <- glm(noexp ~ (mscd + male)*(age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial')
#Test interactions
fit1d <- glm(noexp ~ male + mscd + (age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial') 
fit.final <- glm(noexp ~ male + mscd + (age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial')  


```

To test whether the age effects are truly nonlinear, we perform a likelihood ratio test comparing with a model that only includes linear age effects, and we find that the age spline terms significantly improve model fit (p = `r round(anova(fit1a, fit1b, test='LRT')$"Pr(>Chi)"[2],5)`).  We now test whether each of the interaction effects in the model contribute significantly to model fit.  First, we perform a t-test on the interaction between MSCD and gender, and do not find a statistically significant effect (p = `r round(coefficients(summary(fit1a))[15,4],3)`).  Dropping the MSCD-gender interaction effect, we now perform a likelihood ratio test for the age-MSCD and age-gender interactions.  We do not find a statistically significant improvement in model fit by allowing for age-gender or age-MSCD interactions (p = `r round(anova(fit1c, fit1d, test='LRT')$"Pr(>Chi)"[2],3)`), so we drop these terms from the final model.  Therefore, our final model for zero expenditures is
$$
\text{logit}Pr(Y_i=0) = \beta_0 + \beta_1 MSCD_i + \beta_2 Sex_i + \beta_3 RaceOther_i + \beta_4 HighIncome_i + \beta_5 Age_i + \beta_6 Age_i^3 + \beta_7 (Age_i-60)_+^3.
$$

```{r, cache=TRUE, echo=FALSE, warning=FALSE}
fit1 <- fit1d
# fit1int_est <- coefficients(fit1int)
# fit1int_CI <- confint(fit1int)
# fit1int_tab <- cbind(fit1int_est, fit1int_CI)
# colnames(fit1int_tab)[1] <- 'Estimate'
# fit1int_tab <- signif(fit1int_tab, 3)
# kable(fit1int_tab)
```

Figure 2 shows the observed and fitted probabilities of zero expenditures by age, sex and presence of an MSCD for the group with RaceOther=FALSE and HighIncome=FALSE.  We group age into deciles and compute the observed probabilities of zero expenditures within each decile.  To generate predicted probabilities, we use the median age within each decile.   

```{r, echo=FALSE, message=FALSE, cache=TRUE}
dat_age <- subset(dat, !raceother & !highincome)
dat_age$age_decile <- ntile(dat_age$lastage, 10)
dat_age <- summarise(group_by(dat_age, mscd, male, age_decile, raceother, highincome), age=median(lastage), p = mean(noexp), odds = p/(1-p))
dat_age$age_m40 <- dat_age$age - 40
dat_age$age_m40c <- (dat_age$age_m40)^3
dat_age$age_csp <- (ifelse(dat_age$age_m40>20, dat_age$age_m40-20, 0))^3
dat_age$fittedvals <- predict(fit1, newdata=dat_age, type='response')

fig2 <- ggplot(dat_age, aes(x=age, group=interaction(mscd, male), colour=mscd, linetype=factor(male))) + geom_jitter(aes(y=p)) + geom_line(aes(y=fittedvals), size=1.2) + theme_bw() + theme(legend.position='bottom', legend.box='horizontal', plot.margin=rep(unit(0,"null"),4), text=element_text(size=9), legend.text=element_text(size=6)) + ggtitle('Figure 2') + ylab('Pr(Y=0)') + xlab('Age (Median of Decile)') + scale_linetype_manual('Male', values=c(1,3))
grid.arrange(fig1, fig2, nrow=1) 
```

We now summarise the probability of non-zero expenditures for each age-gender strata (fixing RaceOther=FALSE and HighIncome=FALSE).  To generate predicted probabilities, we use a fixed age that is representative of each group (e.g. 45, 55, 65, 75).  We compute attributable risk as risk difference (the difference in rate of a condition between an exposed population and an unexposed population), namely 
$$
AR\big(Y>0 \big| X\big) = Pr\big(Y>0 \big| X,\text{MSCD}\big) - Pr\big(Y>0 \big| X,\text{no MSCD}\big)
$$


```{r kable, cache=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
dat_pred <- expand.grid(age=c(45,55,65,75), male=c(1,0), mscd=c(FALSE,TRUE), raceother=FALSE, highincome=FALSE) 
dat_pred$age_m40 <- dat_pred$age - 40
dat_pred$age_m40c <- (dat_pred$age_m40)^3
dat_pred$age_csp <- (ifelse(dat_pred$age_m40>20, dat_pred$age_m40-20, 0))^3
dat_pred$pred_zero <- predict(fit1, newdata=dat_pred, type='response')
dat_pred$pred_positive <- 1 - dat_pred$pred_zero
dat_pred$gender <- ifelse(dat_pred$male==1, 'Male','Female')
dat_pred <- dat_pred[c('age','gender','mscd','pred_positive')]

tab_mscd <- subset(dat_pred, mscd)
tab_nomscd <- subset(dat_pred, !mscd)
tab_mscd$pred_mscd <- tab_mscd$pred_positive
tab_mscd$mscd <- tab_mscd$pred_positive <- NULL
tab_nomscd$pred_nomscd <- tab_nomscd$pred_positive
tab_nomscd$mscd <- tab_nomscd$pred_positive <- NULL
tab <- merge(tab_mscd, tab_nomscd)
tab$AR <- tab$pred_mscd - tab$pred_nomscd
names(tab) <- c('Age','Gender','Pr(Y>0,MSCD)','Pr(Y>0,no MSCD)','AR')
tab[,3:5] <- round(tab[,3:5], 3)

tab_male <- subset(tab, Gender=='male')
tab_female <- subset(tab, Gender=='female')
rownames(tab_male) <- tab_male$Age
tab_male$Gender <- tab_female$Gender <- NULL
tab_male$Age <- tab_female$Age <- NULL

tab <- cbind(tab_male, tab_female)
#xtable(tab)
```

\begin{table}[ht]
\centering
\begin{tabular}{c|ccc|ccc}
  \hline
  & \multicolumn{3}{c|}{Males} & \multicolumn{3}{c}{Females} \\
  \hline
Age & Pr(Y$>$0,MSCD) & Pr(Y$>$0,no MSCD) & AR & Pr(Y$>$0,MSCD) & Pr(Y$>$0,no MSCD) & AR \\ 
  \hline
45 & 0.99 & 0.65 & 0.34 & 1.00 & 0.79 & 0.20 \\ 
  55 & 0.99 & 0.68 & 0.31 & 1.00 & 0.81 & 0.18 \\ 
  65 & 0.99 & 0.76 & 0.24 & 1.00 & 0.87 & 0.13 \\ 
  75 & 1.00 & 0.84 & 0.16 & 1.00 & 0.92 & 0.08 \\ 
   \hline
\end{tabular}
\end{table}

#### Model 2. Size of medical expenditures given positive expenditures

We again begin by exploring the association of expenditures with MSCD, age, sex and demographic variables.  Exploratory plots show that for persons with an MSCD, medical expenditures are fairly constant across age and gender.  For subjects without an MSCD, expenditures increase with age, and females have slightly higher expenditures than males.  Exploratory analysis for the potential role of smoking variables (e.g. total pack-years, age started smoking, age stopped smoking) shows weak associations with size of medical expenditures.  However, as the sample contains a large proportion of missing data (up to 50% for some variables), we have not included these variables in the prediction model.  Exploratory plots do not show evidence that race, geographical region, or income are associated with size of medical expenditures.  Therefore, we stratify by MSCD and fit the following models for expenditures: 
\begin{align*}
E(Y_i|MSCD_i=1) &= \beta_0 + \beta_1Age_i \\
E(Y_i|MSCD_i=0) &= \beta_0 + \beta_1Age_i + \beta_2Sex_i + \beta_3Age_iSex_i
\end{align*}

```{r, echo=FALSE, message=FALSE, fig.show='hold', fig.width=4.5, fig.height=5, cache=TRUE}
dat2 <- subset(dat, !noexp)
```

The data are highly skewed, which implies that a Normality assumption for the residuals is inappropriate.  However, since we are interested in modeling the _mean_ expenditures, we can use ordinary least squares to obtain unbiased and efficient coefficient estimates and use bootstrapping to obtain confidence intervals.  (Note: an alternative approach would be to fit a GLM with a log link and a Gaussian or Gamma assumption for the residuals.  In this case, we would check the parametric assumption through QQ plots of the model residuals, and use bootstrapping or the Delta method to obtain confidence intervals on the original data scale.)

```{r, echo=FALSE, message=FALSE, fig.show='hold', fig.width=4.5, fig.height=5, cache=TRUE}
fit2_mscd <- lm(totalexp ~ age_m40, data=subset(dat2, mscd))
fit2_nomscd <- lm(totalexp ~ age_m40*male, data=subset(dat2, !mscd))

```

```{r kable_fit1, echo=FALSE, message=FALSE, fig.show='hold', fig.width=4.5, fig.height=5, cache=TRUE}

```


#### Disease Attributable Fraction of Expenditures (DAFE) due to MSCD

We now compute the expected expenditures by age, gender and MSCD, fixing RaceOther=FALSE and HighIncome=FALSE.  For each covariate profile X, we then compute expected expenses as $E[Y|X]=E[Y|Y>0,X]\times Pr(Y>0|X)$ and Disease Attributable Fraction of Expenditures (DAFE) as
$$
DAFE(X) = \frac{E[Y|X,\text{MSCD}]-E[Y|X,\text{No MSCD}]}{E[Y|X,\text{MSCD}]}.
$$

$E[Y|X]$ and $DAFE(X)$ are both nonlinear functions of quantities that are asymptotically Normal, so they do not follow known distributions. Therefore, we bootstrap subjects 1000 times to obtain 95\% confidence intervals for $E[Y|X]$ and $DAFE(X)$.  We also use the bootstrap samples to obtain confidence intervals for $Pr(Y>0)$ and $E[Y|Y>0]$.  Bootstrap confidence intervals are more appropriate than a Normal approximation for $Pr(Y>0)$, particularly for the MSCD group, which has $Pr(Y>0)$ close to $1$.

In the table below, we summarise the expected values of $Pr(Y>0)$, $E[Y|Y>0]$ and $E[Y]$ by age, gender and presence of an MSCD.  For each age and gender group, we then compute DAFE.  Let $Z$ represent the presence of an MSCD.  Expected expenditures are given in thousands.

```{r, cache=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

dat_pred_boot <- expand.grid(age=c(45,55,65,75), male=c(1,0), mscd=c(FALSE,TRUE), raceother=FALSE, highincome=FALSE) 
dat_pred_boot$age_m40 <- dat_pred_boot$age - 40
dat_pred_boot$age_m40c <- (dat_pred_boot$age_m40)^3
dat_pred_boot$age_csp <- (ifelse(dat_pred_boot$age_m40>20, dat_pred_boot$age_m40-20, 0))^3

### PERFORM BOOTSTRAPPING

get_DAFE <- function(data, inds)
  {
  dat <- data[inds,]
  fit1 <- glm(noexp ~ male + mscd + (age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial') 
  
  dat2 <- subset(dat, !noexp)
  fit2_mscd <- lm(totalexp ~ age_m40, data=subset(dat2, mscd))
  fit2_nomscd <- lm(totalexp ~ age_m40*male, data=subset(dat2, !mscd))
  
  tab <- dat_pred_boot
  #predict Pr(Y>0)
  tab$pred_pos <- 1 - predict(fit1, newdata=tab, type='response')
  #predict E[Y|Y>0]
  tab$pred_exp <- NA
  tab$pred_exp[tab$mscd] <- predict(fit2_mscd, newdata=tab[tab$mscd,], type='response')
  tab$pred_exp[!tab$mscd] <- predict(fit2_nomscd, newdata=tab[!tab$mscd,], type='response')
  #compute E[Y] = Pr(Y>0)*E[Y|Y>0]
  tab$pred_tot <- tab$pred_pos * tab$pred_exp

  #compute DAFE
  tab$Gender <- ifelse(tab$male==1, 'male', 'female')
  tab_mscd <- subset(tab, mscd)
  tab_nomscd <- subset(tab, !mscd)
  tab_mscd <- tab_mscd[c('age','Gender','pred_pos','pred_exp','pred_tot')]
  tab_nomscd <- tab_nomscd[c('age','Gender','pred_pos','pred_exp','pred_tot')]
  names(tab_mscd)[3:5] <- paste0(names(tab_mscd)[3:5],'_mscd')
  names(tab_nomscd)[3:5] <- paste0(names(tab_nomscd)[3:5],'_nomscd')
  tab <- merge(tab_mscd, tab_nomscd)
  tab <- arrange(tab, Gender, age)
  tab$DAFE <- (tab$pred_tot_mscd - tab$pred_tot_nomscd)/tab$pred_tot_mscd
  names(tab) <- c('Age','Gender','Pr(Y>0|Z=1)','E[Y|Y>0,Z=1]','E[Y|Z=1]',
                  'Pr(Y>0|Z=0)','E[Y|Y>0,Z=0]','E[Y|Z=0]','DAFE')
  tab[,c(4,5,7,8)] <- tab[,c(4,5,7,8)]/1000

  return(tab)
}

#get point estimate of each quantity
DAFE_est <- get_DAFE(dat)
DAFE_est[,c(3,6,9)] <- format(round(DAFE_est[,c(3,6,9)],2),nsmall=2)
DAFE_est[,c(4:5,7:8)] <- format(round(DAFE_est[,c(4:5,7:8)],1),nsmall=1)

nBoot <- 100
#store matrix from each bootstrap sample in array
dim_DAFE <- dim(DAFE_est[,-(1:2)])
boot_array <- array(dim=c(dim_DAFE,nBoot))
for(b in 1:nBoot){
  inds <- sort(sample(1:nrow(dat), nrow(dat), replace=TRUE))
  DAFE.b <- get_DAFE(dat, inds)
  boot_array[,,b] <- as.matrix(DAFE.b[,-(1:2)])
}
```

__males__

```{r, cache=TRUE, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
#get boostrap CI
DAFE_LB <- as.data.frame(apply(boot_array, MARGIN = c(1,2), quantile, 0.025))
DAFE_UB <- as.data.frame(apply(boot_array, MARGIN = c(1,2), quantile, 0.975))
 
DAFE_LB[,c(1,4,7)] <- format(round(DAFE_LB[,c(1,4,7)],2), nsmall=2)
DAFE_UB[,c(1,4,7)] <- format(round(DAFE_UB[,c(1,4,7)],2), nsmall=2)
DAFE_LB[,c(2,3,5,6)] <- format(round(DAFE_LB[,c(2,3,5,6)],1),1)
DAFE_UB[,c(2,3,5,6)] <- format(round(DAFE_UB[,c(2,3,5,6)],1),1)

tab <- DAFE_est
for(col in 3:9){
  middle <- tab[,col]
  left <- paste0('$_{',DAFE_LB[,(col-2)],'}')
  right <- paste0('_{',DAFE_UB[,(col-2)],'}$')
  tab[,col] <- paste0(left,middle,right)
}
tab[,1] <- as.character(tab[,1])

tab_male <- subset(tab, Gender=='male')
tab_female <- subset(tab, Gender=='female')
tab_male$Gender <- tab_female$Gender <- NULL

print(xtable(tab_male, align=rep('c',9)), sanitize.text.function=function(x){x}, include.rownames=FALSE, comment=FALSE) 
```

__Females__
```{r, cache=TRUE, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
print(xtable(tab_female, align=rep('c',9)), sanitize.text.function=function(x){x}, include.rownames=FALSE, comment=FALSE)  
```

### Conclusion

Expenditures increase with age for males and females with and without an MSCD, and expenditures are slightly higher for females than for males, particularly for subjects without an MSCD.  The DAFE decreases with age, ranging from `r DAFE_est$DAFE[5]` (`r DAFE_LB[5,7]`, `r DAFE_UB[5,7]`) at age 45 to `r DAFE_est$DAFE[8]` (`r DAFE_LB[8,7]`, `r DAFE_UB[8,7]`) at age 75 for males, and from `r DAFE_est$DAFE[1]` (`r DAFE_LB[1,7]`, `r DAFE_UB[1,7]`) at age 45 to `r DAFE_est$DAFE[4]` (`r DAFE_LB[4,7]`, `r DAFE_UB[4,7]`) at age 75 for females.  Across ages and genders, well over 50% of expenditures can be attributed to having an MSCD.
 
